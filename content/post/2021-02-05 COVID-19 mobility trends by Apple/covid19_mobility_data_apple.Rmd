---
date: "2021-02-05"
title: "COVID-19 mobility trends by Apple"
---

Challenge 1: Learn to use basic data visualisation with tidyverse
Challenge 2: Get to know Apple's COVID-19 mobility trend data

During 2020 several new R-packages providing data relating to the global pandemic COVID-19 were released. One of these is  [**Apple's mobility trend data**](https://covid19.apple.com/mobility), which the tech-giant released to the public in March 2020. (Shortly after [**Google**](https://www.google.com/covid19/mobility/) also released their mobility data which I will dive into in an upcoming post).

Most of my previous coding experience has mostly been done in order to manipulate and wrangle data or arrive to a numeric result produced to an csv-file that was to serve as in input to another program. Hence, my expereince of visualising data (nicely) for presentations or reports is close to non-existent. The challenge for me in this post is to learn to visualize data using [**RMarkdown**](https://rmarkdown.rstudio.com/) and the package [**tidyverse**](https://www.tidyverse.org/).


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages and set wd, include=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, covid19mobility, scales)

# Set work directory on PC
setwd("/Users/ruzicagajic/Documents/Data Scientist/r-website/r-website/content/post/2021-02-05 COVID-19 mobility trends by Apple")
```

The mobility data from both Apple and Google is available in the R [**covid19mobility**](https://github.com/Covid19R/covid19mobility) package. Apple's data is published daily and "reflects requests for directions in Apple Maps" since 13 January 2020 for countries, cities and subregions.

I start by loading the data:

```{r}
# Load Apple's country and city data and add it to a data frame
df_apple_country <- refresh_covid19mobility_apple_country()
df_apple_city <- refresh_covid19mobility_apple_city()

# Use the code below to access Apple's mobilty trend data for subregions of countries. 
# I will be using the data on subregions in a future post.
# df_apple_subregion <- refresh_covid19mobility_apple_subregion()
```

Then I assign values to varaibles in order to faciitate the process of altering the city or country of interest:

```{r}
# Assign the country/city/region you are interested in to variables
country <- "Sweden"
countries <- c(country, "Norway", "Denmark")
cities <- c("Stockholm", "Oslo", "Copenhagen")

# Assign the start and end date of the data to variables for use in captions
start <- as.Date(min(df_apple_country$date))
end <- as.Date(max(df_apple_country$date))
```

Next, I create a custom theme that I want to apply to all plots:

```{r}
my_text_theme <- theme(
  plot.title = element_text(family = "Helvetica", face = "bold", size = (15)),
  plot.subtitle = element_text(family = "Helvetica", size = (10)),
  legend.position = "top",
  legend.title = element_blank(),
  legend.text = element_text(family = "Helvetica", colour="black", size = (10)),
  axis.text = element_text(family = "Helvetica", colour = "black", size = (10)))

theme_set(my_text_theme)
```

The data is very easy to use. First, I filter out mobility trend data for the country Sweden. Then I visualise Apple's three mobility indicators (driving, public transport and walking) for Sweden in a plot:

```{r}

plot1 <- df_apple_country %>%
  filter(location %in% country) %>%
  mutate(mobility_indicator = case_when(
    str_detect(data_type, "driving") ~ "Driving",
    str_detect(data_type, "transit") ~ "Public transport",
    str_detect(data_type, "walking") ~ "Walking")
    ) %>%
  arrange(mobility_indicator) %>%
  
  ggplot(aes(x = date, y = (value/100-1)*100, color = mobility_indicator)) +
  geom_line() +
  theme_bw() +
  my_text_theme +
  
  scale_x_date(expand = c(0,0), labels = date_format("%d %b %Y")) +
  scale_y_continuous(expand = c(0,0)) +
  scale_color_manual(values=c("#003f5c", "#bc5090", "#ffa600")) +
 
  labs(
    title = paste("Apple's mobility index for", country),
    subtitle = paste("Percentage change in routing requests since", as.character(start, "%d %B %Y")),
    caption = "Source: Apple, https://covid19.apple.com/mobility",
    x = "",
    y = ""
  )

plot1

```

Next, I want to compare the mobility indicators for Sweden to those of neighboring Denmark and Norway by facetting the plot:

```{r}

plot2 <- df_apple_country %>%
  filter(location %in% countries) %>%
  mutate(mobility_indicator = case_when(
    str_detect(data_type, "driving") ~ "Driving",
    str_detect(data_type, "transit") ~ "Public transport",
    str_detect(data_type, "walking") ~ "Walking")
    ) %>%
  arrange(mobility_indicator) %>%
  
  ggplot(aes(x = date, y = (value/100 -1)*100, color = mobility_indicator)) +
  geom_line() +
  theme_bw() +
  my_text_theme +
  
  scale_x_date(expand = c(0,0), labels = date_format("%b %y")) +
  scale_y_continuous(expand = c(0,0)) +
  scale_color_manual(values=c("#003f5c", "#bc5090", "#ffa600")) +

  labs(
    title = paste("Comparing Apple's mobility index for", countries[1], "to other countries"),
    subtitle = paste("Percentage change in routing requests since", as.character(start, "%d %B %Y")),
    caption = "Source: Apple, https://covid19.apple.com/mobility",
    x = "",
    y = ""
  ) + 
  
  facet_grid(rows = vars(location)) + #facet by rows
  theme(strip.placement = "outside")

plot2

```

Next, instead of comparing three plots for each country, I want to compare three plots for each mobility indicator. I also facet by columns (instead of by rows as above):

```{r}
plot3 <- df_apple_country %>%
  filter(location %in% countries) %>%
  mutate(mobility_indicator = case_when(
    str_detect(data_type, "driving") ~ "Driving",
    str_detect(data_type, "transit") ~ "Public transport",
    str_detect(data_type, "walking") ~ "Walking")
    ) %>%
  arrange(mobility_indicator) %>%
  
  ggplot(aes(x = date, y = (value/100 -1)*100, color = location)) +  # I change the color to 'location'
  geom_line() +
  theme_bw() +
  my_text_theme +
  
  scale_x_date(expand = c(0,0), labels = date_format("%b %y")) +
  scale_y_continuous(expand = c(0,0)) +
  scale_color_manual(values=c("#003f5c", "#bc5090", "#ffa600")) +

  labs(
    title = paste("Comparing Apple's mobility index for", countries[1], "to other countries"),
    subtitle = paste("Percentage change in routing requests since", as.character(start, "%d %B %Y")),
    caption = "Source: Apple, https://covid19.apple.com/mobility",
    x = "",
    y = ""
  ) + 
  
  facet_grid(cols = vars(mobility_indicator)) + #facet by columns
  theme(strip.placement = "outside")

plot3

```

Next, I am curious to see whether the big uptick in driving during the summer of 2020 in Sweden was concentrated to Sweden's capital Stockholm:

```{r}

plot4 <- df_apple_city %>%
  filter(location %in% cities[1]) %>%
  mutate(mobility_indicator = case_when(
    str_detect(data_type, "driving") ~ "Driving",
    str_detect(data_type, "transit") ~ "Public transport",
    str_detect(data_type, "walking") ~ "Walking")
    ) %>%
  arrange(mobility_indicator) %>%
  
  ggplot(aes(x = date, y = (value/100-1)*100, color = mobility_indicator)) +
  geom_line() +
  theme_bw() +
  my_text_theme +
  
  scale_x_date(expand = c(0,0), labels = date_format("%d %b %Y")) +
  scale_y_continuous(expand = c(0,0)) +
  scale_color_manual(values=c("#003f5c", "#bc5090", "#ffa600")) +
  
  labs(
    title = paste("Apple's mobility index for", cities[1]),
    subtitle = paste("Percentage change in routing requests since", as.character(start, "%d %B %Y")),
    caption = "Source: Apple, https://covid19.apple.com/mobility",
    x = "",
    y = ""
  )

plot4

```

The plot shows no uptick in the mobility indicator "driving" in Stockholm, so the big lift must have happened in the rest of the country. Next I want to compare Stockholm to the capitals of Denmark (Copenhagen) and Norway (Oslo):

```{r, echo=FALSE}

plot5 <- df_apple_city %>%
  filter(location %in% cities) %>%
  mutate(mobility_indicator = case_when(
    str_detect(data_type, "driving") ~ "Driving",
    str_detect(data_type, "transit") ~ "Public transport",
    str_detect(data_type, "walking") ~ "Walking")
    ) %>%
  arrange(mobility_indicator) %>%
  
  ggplot(aes(x = date, y = (value/100 -1)*100, color = mobility_indicator)) +
  geom_line() +
  theme_bw() +
  my_text_theme +
  
  scale_x_date(expand = c(0,0), labels = date_format("%b %y")) +
  scale_y_continuous(expand = c(0,0)) +
  scale_color_manual(values=c("#003f5c", "#bc5090", "#ffa600")) +

  labs(
    title = paste("Comparing Apple's mobility index for", cities[1], "to other capitals"),
    subtitle = paste("Percentage change in routing requests since", as.character(start, "%d %B %Y")),
    caption = "Source: Apple, https://covid19.apple.com/mobility",
    x = "",
    y = ""
  ) + 
  
  facet_grid(rows = vars(location)) +
  theme(strip.placement = "outside")

plot5
```



```{r, echo=FALSE}

plot6 <- df_apple_city %>%
  filter(location %in% cities) %>%
  mutate(mobility_indicator = case_when(
    str_detect(data_type, "driving") ~ "Driving",
    str_detect(data_type, "transit") ~ "Public transport",
    str_detect(data_type, "walking") ~ "Walking")
    ) %>%
  arrange(mobility_indicator) %>%
  
  ggplot(aes(x = date, y = (value/100 -1)*100, color = location)) +
  geom_line() +
  theme_bw() +
  my_text_theme +
  
  scale_x_date(expand = c(0,0), labels = date_format("%b %y")) +
  scale_y_continuous(expand = c(0,0)) +
  scale_color_manual(values=c("#003f5c", "#bc5090", "#ffa600")) +

  labs(
    title = paste("Comparing Apple's mobility index for", cities[1], "to other capitals"),
    subtitle = paste("Percentage change in routing requests since", as.character(start, "%d %B %Y")),
    caption = "Source: Apple, https://covid19.apple.com/mobility",
    x = "",
    y = ""
  ) + 
  
  facet_grid(cols = vars(mobility_indicator)) +
  theme(strip.placement = "outside")

plot6

```

Next, I want to visualise both all three capitals and countries in one single plot:

```{r comparison capitals and countries, echo=FALSE}

capital_and_country <- c("Stockholm", "Copenhagen", "Oslo", "Sweden", "Denmark", "Norway")

join_country <- df_apple_country %>%
  mutate(mobility_indicator = case_when(
    str_detect(data_type, "driving") ~ "Driving",
    str_detect(data_type, "transit") ~ "Public transport",
    str_detect(data_type, "walking") ~ "Walking")) %>%
  select(1:7, mobility_indicator) %>%
  arrange(mobility_indicator)

join_city <- df_apple_city %>%
  mutate(mobility_indicator = case_when(
    str_detect(data_type, "driving") ~ "Driving",
    str_detect(data_type, "transit") ~ "Public transport",
    str_detect(data_type, "walking") ~ "Walking")) %>%
  select(1:7, mobility_indicator) %>%
  arrange(mobility_indicator)

joined_country_city <- rbind(join_country, join_city)

# To change plot order of facet wrap, change the order of varible levels with factor()
joined_country_city$location <- factor(joined_country_city$location, levels = capital_and_country)

# Create facet wrap first with "old" order
plot7 <- joined_country_city %>%
  filter(location %in% capital_and_country) %>%
  ggplot(aes(x = date, y = (value/100 -1)*100, color = mobility_indicator)) +
  geom_line() +
  theme_bw() +
  my_text_theme +
  
  scale_x_date(expand = c(0,0), labels = date_format("%b %y")) +
  scale_y_continuous(expand = c(0,0)) +
  scale_color_manual(values=c("#003f5c", "#bc5090", "#ffa600")) +

  labs(
    title = paste("Comparing Apple's mobility index for some countries and capitals"),
    subtitle = paste("Percentage change in routing requests since", as.character(start, "%d %B %Y")),
    caption = "Source: Apple, https://covid19.apple.com/mobility",
    x = "",
    y = ""
  ) + 

  facet_wrap(facets = vars(location))
  
# Add new order to facet wrap
plot7 + facet_wrap(~ location) 
```

And last but not least, I want to compare the mobility trend indicators for Sweden to the three biggest cities in the country: 1. [**Stockholm**](https://en.wikipedia.org/wiki/Stockholm), 2. [**Gothenburg**](https://en.wikipedia.org/wiki/Gothenburg) and 3. [**Malmö**](https://en.wikipedia.org/wiki/Malm%C3%B6). Oddly, the city Malmö is spelled using the Swedish letter "ö" in the Apple data, while Gothenburg (in Swedish: Göteborg) is spelled in English "Gothenburg". Interesting, I wonder why that is?

```{r comparison sweden internal, echo=FALSE}

sweden_cities <- c("Sweden", "Stockholm", "Gothenburg", "Malmö")

join_country <- df_apple_country %>%
  mutate(mobility_indicator = case_when(
    str_detect(data_type, "driving") ~ "Driving",
    str_detect(data_type, "transit") ~ "Public transport",
    str_detect(data_type, "walking") ~ "Walking")) %>%
  select(1:7, mobility_indicator) %>%
  arrange(mobility_indicator)

join_city <- df_apple_city %>%
  mutate(mobility_indicator = case_when(
    str_detect(data_type, "driving") ~ "Driving",
    str_detect(data_type, "transit") ~ "Public transport",
    str_detect(data_type, "walking") ~ "Walking")) %>%
  select(1:7, mobility_indicator) %>%
  arrange(mobility_indicator)

joined_country_city <- rbind(join_country, join_city)

# To change plot order of facet wrap, change the order of varible levels with factor()
joined_country_city$location <- factor(joined_country_city$location, levels = sweden_cities)

# Create facet wrap first with "old" order
plot8 <- joined_country_city %>%
  filter(location %in% sweden_cities) %>%
  ggplot(aes(x = date, y = (value/100 -1)*100, color = mobility_indicator)) +
  geom_line() +
  theme_bw() +
  my_text_theme +
  
  scale_x_date(expand = c(0,0), labels = date_format("%b %y")) +
  scale_y_continuous(expand = c(0,0)) +
  scale_color_manual(values=c("#003f5c", "#bc5090", "#ffa600")) +

  labs(
    title = paste("Comparing Apple's mobility index for", sweden_cities[1], "and it's biggest cities"),
    subtitle = paste("Percentage change in routing requests since", as.character(start, "%d %B %Y")),
    caption = "Source: Apple, https://covid19.apple.com/mobility",
    x = "",
    y = ""
  ) + 

  facet_wrap(facets = vars(location))
  
# Add new order to facet wrap
plot8 + facet_wrap(~ location)
```

That was all for now! Omg, there were so many more possibilities available for tweaking plots when using ggplot2 in tidyverse than I expected. I really had to spend quite some time online reading documentation and checking examples. The possibilites are truely immense so please see the above as a glimpse into the world of tidy! I can warmly recommend the folowing page on the website [**datacarpentry.org**](https://datacarpentry.org/R-ecology-lesson/04-visualization-ggplot2) that I found particularly useful for the type of data used in this post.